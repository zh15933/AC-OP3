#
# Fork 同步上游（datout/Openwrt-Auto）用：
# - 先备份常见自定义文件（diy-part/seed/settings/custom）到 artifact
# - 再将上游 main 合并到你自己的默认分支（无 PR，直接推送）
#

name: Sync upstream

on:
  workflow_dispatch:
  # forks 默认不会自动跑 schedule（需要在 fork 里手动启用），这里保留不影响
  schedule:
    - cron: '17 3 * * *'

permissions:
  contents: write

jobs:
  sync:
    if: github.repository != 'datout/Openwrt-Auto'
    runs-on: ubuntu-latest

    steps:
    - name: Checkout default branch
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.repository.default_branch }}
        fetch-depth: 0
        token: ${{ secrets.REPO_TOKEN || github.token }}

    - name: Configure git
      run: |
        git config user.name  "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

    - name: Fetch upstream
      run: |
        set -e
        UPSTREAM_REPO="datout/Openwrt-Auto"
        UPSTREAM_BRANCH="main"
        echo "UPSTREAM_REPO=${UPSTREAM_REPO}" >> $GITHUB_ENV
        echo "UPSTREAM_BRANCH=${UPSTREAM_BRANCH}" >> $GITHUB_ENV

        git remote add upstream "https://github.com/${UPSTREAM_REPO}.git" 2>/dev/null || true
        git fetch upstream "${UPSTREAM_BRANCH}" --prune

        echo "Fork HEAD: $(git rev-parse --short HEAD)"
        echo "Upstream : $(git rev-parse --short upstream/${UPSTREAM_BRANCH})"

    - name: Check if behind
      run: |
        set -e
        behind=$(git rev-list --count HEAD..upstream/${UPSTREAM_BRANCH} || echo 0)
        echo "BEHIND=${behind}" >> $GITHUB_ENV
        if [ "${behind}" -eq 0 ]; then
          echo "Already up to date."
          exit 0
        fi
        echo "Need sync: behind ${behind} commit(s)."

    - name: Backup custom files
      run: |
        set -e
        ts=$(date -u +%Y%m%d_%H%M%S)
        backup="/tmp/custom-backup-${ts}.tar.gz"
        shopt -s nullglob
        tar -czf "${backup}" \
          build/*/diy-part.sh \
          build/*/settings.ini \
          build/*/seed \
          build/*/relevance \
          common/custom \
          --ignore-failed-read || true
        echo "BACKUP=${backup}" >> $GITHUB_ENV
        ls -lh "${backup}" || true

    - name: Upload backup artifact
      uses: actions/upload-artifact@v4
      with:
        name: custom-backup
        path: ${{ env.BACKUP }}
        if-no-files-found: ignore

    - name: Merge upstream into fork (no PR)
      run: |
        set -e
        # 尽量自动合并：优先使用上游变更（theirs）
        git merge --no-edit -X theirs "upstream/${UPSTREAM_BRANCH}" || {
          echo "::error::Merge conflict. Please resolve manually."
          git merge --abort || true
          exit 1
        }

    - name: Restore custom files after sync
      run: |
        set -e
        # 恢复自定义文件（避免被上游覆盖）
        tar -xzf "${BACKUP}" -C . || true
        git add -A
        if git diff --cached --quiet; then
          echo "No custom changes to re-commit."
        else
          git commit -m "Restore custom files after syncing upstream" || true
        fi

    - name: Push to origin
      run: |
        set -e
        branch="${{ github.event.repository.default_branch }}"
        git push origin HEAD:"${branch}"
